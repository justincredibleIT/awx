---
- name: Validate runner host
  ansible.builtin.assert:
    that:
      - awx_runner_host is defined
      - awx_runner_host | length > 0
    fail_msg: "awx_runner_host is not set (expected groups['k3s_servers'][0])."

- name: Assert kubeconfig exists on runner host
  ansible.builtin.stat:
    path: "{{ awx_kubeconfig_path }}"
  register: awx_kcfg
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

- name: Fail if kubeconfig missing on runner host
  ansible.builtin.assert:
    that:
      - awx_kcfg.stat.exists
    fail_msg: "k3s kubeconfig not found at {{ awx_kubeconfig_path }} on {{ awx_runner_host }}."
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

- name: Ensure AWX namespace exists
  ansible.builtin.shell: |
    set -euo pipefail
    kubectl --kubeconfig {{ awx_kubeconfig_path }} get ns {{ awx_namespace }} >/dev/null 2>&1 || \
      kubectl --kubeconfig {{ awx_kubeconfig_path }} create ns {{ awx_namespace }}
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

# -----------------------------------------------------------------------------
# Bridge Secret: Reformat Crunchy PGO secret for the AWX Operator
# -----------------------------------------------------------------------------

- name: Fetch credentials from Crunchy PGO secret
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      get secret awxdb-ha-pguser-awx -o json
  register: crunchy_secret_raw
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

- name: Extract Postgres password fact
  ansible.builtin.set_fact:
    pg_pass_b64: "{{ (crunchy_secret_raw.stdout | from_json).data.password }}"
  run_once: true

- name: Create AWX configuration bridge secret
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ awx_kubeconfig_path }} apply -f - <<EOF
    apiVersion: v1
    kind: Secret
    metadata:
      name: "{{ awx_name }}-postgres-configuration"
      namespace: "{{ awx_namespace }}"
    type: Opaque
    stringData:
      host: "awxdb-ha-ha"
      port: "5432"
      database: "awx"
      username: "awx"
      password: "{{ pg_pass_b64 | b64decode }}"
      sslmode: "prefer"
      type: "unmanaged"
    EOF
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

- name: Set finalized secret name fact
  ansible.builtin.set_fact:
    awx_postgres_configuration_secret: "{{ awx_name }}-postgres-configuration"
  run_once: true

- name: Grant schema permissions to AWX user
  ansible.builtin.shell: |
    MASTER_POD=$(kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} get pods -l postgres-operator.crunchydata.com/role=master --no-headers -o custom-columns=":metadata.name" | head -n 1)
    
    if [ -z "$MASTER_POD" ]; then
      echo "No master pod found"
      exit 1
    fi

    kubectl --kubeconfig {{ awx_kubeconfig_path }} exec -n {{ awx_namespace }} "$MASTER_POD" -- psql -d awx -c 'GRANT ALL ON SCHEMA public TO awx;'
  args:
    executable: /bin/bash  # This fixes the "Illegal option" error
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  register: grant_result
  until: grant_result.rc == 0
  retries: 10
  delay: 15
# ------------------------------
# Render AWX CR
# ------------------------------
- name: Build AWX CR manifest object
  ansible.builtin.set_fact:
    awx_cr_obj: >-
      {{
        {
          'apiVersion': 'awx.ansible.com/v1beta1',
          'kind': 'AWX',
          'metadata': {
            'name': awx_name,
            'namespace': awx_namespace
          },
          'spec': (
            {
              'replicas': (awx_replicas | int),
              'service_type': awx_service_type,
              'service_annotations': (awx_service_annotations | default('')),
              'extra_settings': (awx_extra_settings | default([]))
            }
            | combine(
                (
                  {'loadbalancer_ip': awx_loadbalancer_ip}
                  if (awx_service_type == 'LoadBalancer' and (awx_loadbalancer_ip | default('') | length) > 0)
                  else {}
                ),
                recursive=True
              )
            | combine(
                (
                  {
                    'projects_persistence': True,
                    'projects_storage_class': awx_projects_storage_class,
                    'projects_storage_size': awx_projects_storage_size,
                    'projects_storage_access_mode': 'ReadWriteOnce'
                  }
                  if (awx_projects_persistence | bool)
                  else {'projects_persistence': False}
                ),
                recursive=True
              )
            | combine(
                (
                  {}
                  if (awx_manage_postgres | bool)
                  else {'postgres_configuration_secret': awx_postgres_configuration_secret}
                ),
                recursive=True
              )
            | combine(
                (
                  {'admin_password_secret': awx_admin_password_secret}
                  if (awx_admin_password_secret | default('') | length) > 0
                  else {}
                ),
                recursive=True
              )
          )
        }
      }}
  run_once: true

- name: Render AWX CR manifest to runner
  ansible.builtin.copy:
    dest: "/tmp/{{ awx_name }}.yaml"
    mode: "0644"
    content: "{{ awx_cr_obj | to_nice_yaml }}"
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

- name: Apply AWX CR
  ansible.builtin.command:
    argv:
      - kubectl
      - --kubeconfig
      - "{{ awx_kubeconfig_path }}"
      - apply
      - -f
      - "/tmp/{{ awx_name }}.yaml"
  run_once: true
  delegate_to: "{{ awx_runner_host }}"

# -----------------------------------------------------------------------------
# RWO Projects: Pin web + task to same node (prevents Multi-Attach)
# -----------------------------------------------------------------------------

- name: RWO pinning | Wait for AWX deployments to exist
  ansible.builtin.shell: |
    set -euo pipefail
    ns="{{ awx_namespace }}"
    for d in "{{ awx_name }}-web" "{{ awx_name }}-task"; do
      for i in $(seq 1 60); do
        if kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" get deploy "$d" >/dev/null 2>&1; then
          echo "Found deploy $d"
          break
        fi
        sleep 2
      done
      kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" get deploy "$d" >/dev/null
    done
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool
  changed_when: false

- name: RWO pinning | Determine node to pin to (explicit or auto from running web pod)
  ansible.builtin.shell: |
    set -euo pipefail
    ns="{{ awx_namespace }}"

    if [ -n "{{ awx_pin_node_name | default('') }}" ]; then
      echo "{{ awx_pin_node_name }}"
      exit 0
    fi

    # Wait for at least one web pod to appear, then use its node
    for i in $(seq 1 60); do
      node=$(kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" \
        get pod -l app.kubernetes.io/name="{{ awx_name }}-web" \
        -o jsonpath='{.items[0].spec.nodeName}' 2>/dev/null || true)
      if [ -n "$node" ]; then
        echo "$node"
        exit 0
      fi
      sleep 2
    done

    echo "ERROR: Could not determine a web pod node to pin to."
    exit 1
  args:
    executable: /bin/bash
  register: awx_pin_node
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool
  changed_when: false

- name: RWO pinning | Label pin node
  ansible.builtin.shell: |
    set -euo pipefail
    node="{{ awx_pin_node.stdout }}"
    kubectl --kubeconfig {{ awx_kubeconfig_path }} label node "$node" \
      "{{ awx_pin_label_key }}={{ awx_pin_label_value }}" --overwrite
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool

- name: RWO pinning | Patch web deployment nodeSelector
  ansible.builtin.shell: |
    set -euo pipefail
    ns="{{ awx_namespace }}"
    dep="{{ awx_name }}-web"
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" patch deploy "$dep" --type merge -p \
      '{"spec":{"template":{"spec":{"nodeSelector":{"{{ awx_pin_label_key }}":"{{ awx_pin_label_value }}"}}}}}'
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool

- name: RWO pinning | Patch task deployment nodeSelector
  ansible.builtin.shell: |
    set -euo pipefail
    ns="{{ awx_namespace }}"
    dep="{{ awx_name }}-task"
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" patch deploy "$dep" --type merge -p \
      '{"spec":{"template":{"spec":{"nodeSelector":{"{{ awx_pin_label_key }}":"{{ awx_pin_label_value }}"}}}}}'
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool

- name: RWO pinning | Restart web/task pods to pick up new scheduling
  ansible.builtin.shell: |
    set -euo pipefail
    ns="{{ awx_namespace }}"
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" rollout restart deploy "{{ awx_name }}-web"
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n "$ns" rollout restart deploy "{{ awx_name }}-task"
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_pin_web_task_same_node | bool

# ------------------------------
# Wait / Verify
# ------------------------------
- name: Wait for AWX CR to show a status
  ansible.builtin.shell: |
    set -euo pipefail
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} get awx {{ awx_name }} -o yaml | sed -n '1,200p'
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  changed_when: false

# ------------------------------
# Wait / Verify
# ------------------------------

- name: Wait for AWX web service to exist
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      get svc {{ awx_name }}-service
  register: awx_svc_check
  # Retry for 15 minutes (60 retries * 15 seconds)
  until: awx_svc_check.rc == 0
  retries: 60
  delay: 15
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_wait_ready | bool
  changed_when: false

- name: Wait for AWX deployments to exist before waiting for 'Available'
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      get deploy {{ awx_name }}-web && \
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      get deploy {{ awx_name }}-task
  register: awx_deploy_check
  until: awx_deploy_check.rc == 0
  retries: 60
  delay: 15
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_wait_ready | bool
  changed_when: false

- name: Wait for AWX deployments to be available (Ready)
  ansible.builtin.shell: |
    set -euo pipefail
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      wait --for=condition=Available "deploy/{{ awx_name }}-web" --timeout={{ awx_wait_timeout }}
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} \
      wait --for=condition=Available "deploy/{{ awx_name }}-task" --timeout={{ awx_wait_timeout }}
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  when: awx_wait_ready | bool

- name: Show AWX status (pods + svc)
  ansible.builtin.shell: |
    set -euo pipefail
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} get pods -o wide
    echo
    kubectl --kubeconfig {{ awx_kubeconfig_path }} -n {{ awx_namespace }} get svc -o wide
  args:
    executable: /bin/bash
  run_once: true
  delegate_to: "{{ awx_runner_host }}"
  changed_when: false