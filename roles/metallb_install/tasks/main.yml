---
# MetalLB install + config
# All cluster operations run on the "admin runner" node, NOT localhost.

- name: Determine admin runner node
  ansible.builtin.set_fact:
    metallb_admin_runner: >-
      {{
        (metallb_admin_host | length > 0)
        | ternary(metallb_admin_host, groups['k3s_servers'][0])
      }}
  run_once: true

- name: Assert kubeconfig exists on admin runner
  ansible.builtin.stat:
    path: "{{ metallb_kubeconfig }}"
  register: metallb_kcfg
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Fail if kubeconfig missing
  ansible.builtin.assert:
    that:
      - metallb_kcfg.stat.exists
    fail_msg: "Kubeconfig not found at {{ metallb_kubeconfig }} on {{ metallb_admin_runner }}. Run k3s install first."
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Ensure metallb namespace exists (check)
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    get ns {{ metallb_namespace }}
  register: metallb_ns_check
  failed_when: false
  changed_when: false
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Create metallb namespace (if missing)
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    create ns {{ metallb_namespace }}
  when: metallb_ns_check.rc != 0
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Add MetalLB Helm repo
  ansible.builtin.command: >
    helm repo add {{ metallb_helm_repo_name }} {{ metallb_helm_repo_url }}
  register: metallb_helm_repo_add
  changed_when: "'already exists' not in (metallb_helm_repo_add.stdout | default('') + metallb_helm_repo_add.stderr | default(''))"
  failed_when: metallb_helm_repo_add.rc != 0 and ("already exists" not in (metallb_helm_repo_add.stderr | default('')))
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Helm repo update
  ansible.builtin.command: helm repo update
  changed_when: false
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Install/upgrade MetalLB (Helm)
  ansible.builtin.command: >
    helm upgrade --install {{ metallb_release_name }} {{ metallb_chart_name }}
    --namespace {{ metallb_namespace }}
    --kubeconfig {{ metallb_kubeconfig }}
    {% if metallb_chart_version | length > 0 %} --version {{ metallb_chart_version }} {% endif %}
    {% if metallb_helm_values | length > 0 %} --values - {% endif %}
  args:
    stdin: "{{ metallb_helm_values | to_nice_yaml if (metallb_helm_values | length > 0) else omit }}"
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Wait for MetalLB controller deployment to be available
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    -n {{ metallb_namespace }}
    wait --for=condition=Available deploy/{{ metallb_release_name }}-controller --timeout={{ metallb_wait_timeout }}
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Wait for MetalLB speaker daemonset to be ready
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    -n {{ metallb_namespace }}
    rollout status ds/{{ metallb_release_name }}-speaker --timeout={{ metallb_wait_timeout }}
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

# --- FIXED: Use inline stdin to allow variables from playbook ---

- name: Apply IPAddressPool (templated from metallb_ip_range)
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    -n {{ metallb_namespace }}
    apply -f -
  args:
    stdin: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: svc-pool-static
        namespace: {{ metallb_namespace }}
      spec:
        addresses:
          {{ metallb_ip_range | to_yaml }}
        autoAssign: true
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Apply L2Advertisement (stdin)
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    -n {{ metallb_namespace }}
    apply -f -
  args:
    stdin: |
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: l2-adv-static
        namespace: {{ metallb_namespace }}
      spec:
        ipAddressPools:
          - svc-pool-static
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true

- name: Show MetalLB resources
  ansible.builtin.command: >
    kubectl --kubeconfig {{ metallb_kubeconfig }}
    -n {{ metallb_namespace }}
    get ipaddresspools,l2advertisements -o wide
  changed_when: false
  delegate_to: "{{ metallb_admin_runner }}"
  run_once: true